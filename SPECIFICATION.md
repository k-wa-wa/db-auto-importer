# db-auto-importer 仕様書

## 1. ツール名
`db-auto-importer`

## 2. 目的
RDBMS に csv ファイル群を自動的にインポートする。
csv データが DB 上に反映されていることを担保するため、外部キー制約を考慮して必要に応じて親テーブルのレコードを自動生成する。

## 3. 技術スタック
*   **言語**: Go
*   **データベース**: PostgreSQL / DB2
*   **CSVパーシング**: Go標準ライブラリ `encoding/csv`
*   **DBアクセス**: `database/sql`

## 4. 入力
*   **CSVファイル群**: 特定のディレクトリに配置されたCSVファイル。ファイル名はテーブル名と一致することを基本とする（例: `users.csv` -> `users` テーブル）。
*   **データベース接続情報**: 環境変数またはCLI引数で提供（例: `PG_CONN_STR="postgresql://user:password@host:port/dbname?sslmode=disable"`）。

## 5. 主要機能と処理フロー

### 5.1. データベーススキーマの動的検出
1.  **テーブル情報の取得**: ツール起動時に、接続先の RDBMS から全てのテーブル名、カラム名、データ型、NULL許容性、プライマリキー、ユニークキー、外部キー制約情報を動的に取得します。RDBMS の挙動の違いはここで吸収します。
2.  **外部キー依存関係の構築**: 取得した外部キー情報に基づき、テーブル間の依存関係（親-子関係）を示す有向グラフ（DAG: Directed Acyclic Graph）を構築します。これにより、インポート順序を決定します。

### 5.2. CSVファイルの読み込みとマッピング
1.  **CSVファイルの特定**: 指定されたディレクトリ内の全ての`.csv`ファイルを読み込み対象とします。
2.  **テーブル名との紐付け**: CSVファイル名（拡張子を除く）を対応するテーブル名と見なします。
3.  **ヘッダー行の解析**: 各CSVファイルの1行目をヘッダー行として読み込み、カラム名を抽出します。データベースのカラム名とのマッピングは、大文字・小文字を区別しないマッチングを基本とし、必要に応じて設定ファイルでエイリアスを定義できるようにします。

### 5.3. インポート順序の決定
1.  **トポロジカルソート**: 構築したテーブル依存関係グラフに対し、トポロジカルソートを実行します。これにより、外部キー制約に違反しないインポート順序（親テーブルが子テーブルより先に処理される順序）を決定します。
2.  **循環参照の検出と報告**: 外部キー制約に循環参照がある場合、ツールはそれを検出し、エラーとして報告し、処理を停止します。

### 5.4. データインポートロジック

1.  **トランザクション管理**: 各テーブルのインポートは単一のトランザクション内で行うか、または全てのテーブルのインポートを単一の大きなトランザクションで行うかを選択可能にします（デフォルトはテーブルごと）。これにより、部分的なデータ破損を防ぎます。
2.  **レコードの挿入**:
    *   CSVの各行を読み込み、対応するテーブルに挿入します。
    *   **既存レコードの扱い**:
        *   デフォルトは`UPSERT`。プライマリキーまたはユニークキーの重複がある場合は既存レコードを更新する。
3.  **親レコードの自動生成**:
    *   子テーブルのレコードを挿入する際、そのレコードが参照する親テーブルのプライマリキー値がデータベースに存在しない場合、親テーブルに新しいレコードを自動的に挿入します。
    *   自動生成される親レコードの他のカラムには、以下のデフォルト値を設定します。
        *   `NULL`許容のカラム: `NULL`
        *   `NOT NULL`制約のあるカラム:
            *   文字列型: 空文字列 (`''`)
            *   数値型: `0`
            *   ブール型: `FALSE`
            *   日付/時刻型: データベースのデフォルト値または`'0001-01-01 00:00:00Z'`のような最小値
            *   プライマリキー: CSVから取得した値、またはデータベースのシーケンス/UUID生成機能を利用。
    *   自動生成されたレコードはログに記録し、ユーザーが確認できるようにします。

### 5.5. エラーハンドリングとロギング
*   **詳細なログ出力**: 処理の各段階（DB接続、スキーマ検出、CSV読み込み、インポート順序決定、各レコードの挿入/更新、エラー、親レコード生成など）で詳細なログを出力します。
*   **エラー報告**: データベースエラー、CSVパースエラー、外部キー制約違反（親レコード自動生成で解決できない場合）、循環参照など、発生した全てのエラーを明確に報告します。
*   **統計情報**: インポート完了後、成功したレコード数、スキップされたレコード数、自動生成された親レコード数などの統計情報を表示します。

## 6. コマンドラインインターフェース (CLI)
*   `db-auto-importer --csv-dir /path/to/csvs --db-conn "..."`
*   `--dry-run`: 実際のDB操作を行わず、インポート計画とエラーチェックのみを行うオプション

## 7. 考慮事項
*   **パフォーマンス**: 大量のデータインポートに対応するため、`COPY FROM`コマンドの利用やバッチ挿入など、PostgreSQLの高速インポート機能を活用します。
*   **データ型変換**: CSVの文字列データをデータベースのカラム型に正しく変換するロジックを実装します。
*   **スキーマ変更への対応**: データベーススキーマが変更された場合でも、ツールが動的に適応できるように設計します。
